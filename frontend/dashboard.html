<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Verstegen AI</title>
    <link rel="stylesheet" href="./static/style.css">
    <link rel="stylesheet" href="./static/themes.min.css">
    <style>
        body {
            margin: 0;
            background-color: #f5f5f5;
            font-family: "Prompt", sans-serif;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #cd0b35;
            color: white;
            padding: 15px 30px;
        }

        .header-left a {
            color: white;
            margin-right: 20px;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }

        .header-left a:hover {
            text-decoration: underline;
        }

        .header-right button {
            background-color: white;
            color: #cd0b35;
            border: none;
            padding: 8px 14px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
        }

        .header-right button:hover {
            background-color: #f1f1f1;
        }

        .content {
            text-align: center;
            margin-top: 40px;
        }

        .content h1 {
            font-size: 36px;
            color: #005B43;
            font-family: "DIN Next LT W04 Heavy Condensed", sans-serif;
            text-transform: uppercase;
        }

        #chat-section {
            display: none;
        }

        #chat-history {
            margin: 40px auto;
            width: 80%;
            text-align: left;
        }

        .chat-block {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .chat-entry {
            margin-bottom: 10px;
            padding: 10px;
            background: #f2f2f2;
            border-radius: 6px;
        }

        .chat-entry strong {
            color: #cd0b35;
        }

        .label-grid {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .label-item {
            background-color: #cd0b35;
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .label-item.active {
            background-color: #444;
        }


        .chat-entry.feedback-good {
            background-color: #e2feed;
            /* zacht groen */
        }

        .chat-entry.feedback-bad {
            background-color: #f2d5d5;
            /* zacht rood */
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-left">
            <a href="/dashboard">Dashboard</a>
            <a onclick="showChats()">Chats beheren</a>
            <a href="/data_management">Data beheren</a>
        </div>
        <div class="header-right">
            <button onclick="logout()">Uitloggen</button>
        </div>
    </div>
    <div class="content">
        <h1 id="welcome-msg">Welkom terug!</h1>
    </div>

    <div id="chat-section">
        <hr style="width: 80%; margin: 40px auto; border: 1px solid #ccc;">
        <h2 style="text-align: center;">Chatgeschiedenis</h2>
        <div id="label-list" class="label-grid"></div>
        <div id="chat-history"></div>
    </div>

    <script>
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "/login";
        }

        let allChats = {};
        let activeLabel = null;

        fetch("/me", {
            headers: {
                "Authorization": "Bearer " + token
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.username) {
                    document.getElementById("welcome-msg").textContent = `Welkom terug, ${data.username}!`;
                }
            });

        function logout() {
            localStorage.removeItem("token");
            window.location.href = "/";
        }

        function showChats() {
            document.getElementById("chat-section").style.display = "block";
            loadLabels();
            loadChats();
        }

        function loadChats(filterLabel = null) {
            fetch("/all_chats", {
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
                .then(res => res.json())
                .then(data => {
                    allChats = data;
                    displayChats(filterLabel);
                });
        }

        function displayChats(filterLabel = null) {
            const chatDiv = document.getElementById("chat-history");
            chatDiv.innerHTML = "";

            const keywords = {
                vakantie: ["vakantie", "vakantiedagen", "verlof", "vrij nemen", "zomervakantie", "kerstvakantie", "feestdag"],
                ziekmelding: ["ziekmelden", "ziekmelding", "ziek", "ziek thuis", "ziekte", "griep", "meld ziek"],
                contract: ["contract", "arbeidsovereenkomst", "verlenging", "tijdelijk", "vast contract", "proeftijd", "ontslag"],
                salaris: ["salaris", "loon", "betaling", "loonstrook", "maandsalaris", "salarisbetaling", "uren uitbetaald"],
                werktijden: ["rooster", "werktijden", "diensten", "ploegendienst", "werktijd", "overwerken", "urenregistratie"],
                pensioen: ["pensioen", "pensioenregeling", "pensioenfonds", "met pensioen", "aow", "opbouw"],
                onboarding: ["inwerken", "introductie", "welkom", "starten", "eerste werkdag", "handleiding", "instructieboekje"],
                beoordeling: ["functioneringsgesprek", "beoordeling", "evaluatie", "functioneren", "prestatie", "ontwikkelgesprek"],
                opleiding: ["opleiding", "training", "bijscholing", "cursus", "leren", "ontwikkelen", "studie", "leermodule"],
                reiskosten: ["reiskosten", "reiskostenvergoeding", "ov", "kilometervergoeding", "reisvergoeding", "woon-werkverkeer"],
                verlofregelingen: ["ouderschapsverlof", "zwangerschapsverlof", "zorgverlof", "bijzonder verlof", "calamiteitenverlof"],
                veiligheid: ["veiligheid", "bhv", "bedrijfshulpverlening", "veiligheidsinstructies", "incident", "ongeval"],
                cao: ["cao", "collectieve arbeidsovereenkomst", "cao afspraken", "cao verstegen"],
                klokken: ["tijdregistratie", "klokken", "inklokken", "uitklokken", "tijdklok", "uren boeken"],
                overig: []  // Fallback-categorie
            };


            for (const [chatId, messages] of Object.entries(allChats)) {
                if (filterLabel) {
                    const matches = messages.some(entry => {
                        const userText = entry.user.toLowerCase();

                        if (filterLabel === "overig") {
                            // Alleen tonen als g√©√©n van de andere categorie√´n matchen
                            return !Object.entries(keywords).some(([label, kws]) =>
                                label !== "overig" && kws.some(kw => userText.includes(kw))
                            );
                        }

                        return keywords[filterLabel].some(kw => userText.includes(kw));
                    });

                    if (!matches) continue;
                }
                const chatBlock = document.createElement("div");
                chatBlock.className = "chat-block";
                chatBlock.innerHTML = `<h3>Chat ID: ${chatId}</h3>`;

                messages.forEach(entry => {
                    let feedbackIcon = "";
                    let feedbackClass = "";
                    if (entry.feedback === 1) {
                        feedbackIcon = "Goed antwoord üëç";
                        feedbackClass = "feedback-good";
                    } else if (entry.feedback === -1) {
                        feedbackIcon = "Slecht antwoord üëé";
                        feedbackClass = "feedback-bad";
                    }
                    chatBlock.innerHTML += `
        <div class="chat-entry ${feedbackClass}">
            <strong>Gebruiker:</strong> ${entry.user}<br>
            <strong>AI:</strong> ${entry.bot}<br>
            ${feedbackIcon ? `<strong>Feedback: </strong>${feedbackIcon}` : ""}
        </div>`;
                });

                chatDiv.appendChild(chatBlock);
            }
        }

        function loadLabels() {
            fetch("/chat_labels", {
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById("label-list");
                    container.innerHTML = "";
                    for (const [label, count] of Object.entries(data)) {
                        if (count === 0) continue;
                        const div = document.createElement("div");
                        div.className = "label-item";
                        div.textContent = `${label} (${count})`;
                        div.onclick = () => toggleFilter(div, label);
                        container.appendChild(div);
                    }
                });
        }

        function toggleFilter(element, label) {
            const items = document.querySelectorAll(".label-item");
            items.forEach(el => el.classList.remove("active"));

            if (activeLabel === label) {
                activeLabel = null;
                displayChats();
            } else {
                activeLabel = label;
                element.classList.add("active");
                displayChats(label);
            }
        }
    </script>
</body>

</html>